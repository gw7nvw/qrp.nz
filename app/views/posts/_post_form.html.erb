<script type="text/javascript">
   bkLib.onDomLoaded(startEdit);

function startEdit() {
  nicEditors.allTextAreas();
  init();
}
</script>

<div class="fullform">
   <%= form_for(@post) do |f| %>
     <%=hidden_field_tag(:topic_id, @topic.id)%>
     <div id="actionbar-form" class="span12">
       <div id="crumbs">
         <%=link_to "Home", '/'%>
         &nbsp;--&gt;&nbsp;
         <%=  link_to  "Topics", '/topics'%>
         &nbsp;--&gt;&nbsp;
         <%if @topic%>
            <b><%=link_to @topic.name, '/topics/'+@topic.url%></b>
            &nbsp;--&gt;&nbsp;
         <% end %>
         <%if @post.id%>
            <b><%=link_to @post.title, '/posts/'+@post.id.to_s%></b>
            &nbsp;--&gt;&nbsp;
            <b>Edit</b>
         <% else %>
            <b>New</b>
         <% end %>

       </div>

       <div id="controls">
          <%= f.submit @submit_button, class: "btn btn-small btn-primary btn-highlight" %>
          <% if @post.id %><% if params[:referring]=='index'%>
            <%=  link_to "Cancel", '/posts', class: "btn btn-small btn-primary"%>
          <% else %>
            <%=  link_to "Cancel", '/posts/'+@post.id.to_s, class: "btn btn-small btn-primary"%>
          <% end %> <% end %>

          <%  if(@submit_button == "Save Changes" and (current_user.is_admin or current_user.id==@post.created_by_id)) %>
            <%= f.submit "Delete Post", confirm: "Delete post: Are you sure?", class: "btn btn-small btn-primary", id:  "deletebutton" %>
          <% end %>

       </div>
     </div>


     <div id="left_panel"  style="margin-top:0px !important">
        <%=render 'layouts/left_panel'%>
     </div>
     <div id="right_panel"  style="margin-top:0px !important">


       <%= render 'shared/error_messages' %>	

       <div id="right_scroll">

         <% if @topic.is_spot or @topic.is_alert then %>
           <b><%=@topic.name%></b><br>
           <table>
             <% if @topic.is_spot then %>
               <tr>
                 <td>Operating callsign:</td>
                 <td style="padding:0px; margin:0px;" colspan=3><%=f.text_field :callsign, :style =>"padding:0px; margin:0px;" %></td>
               </tr>
             <% end %>
             <tr>
                   <td>On/from:</td>
                   <td style="padding:0px; margin:0px;"><%=   f.date_field :referenced_date, :style =>"padding:0px; margin:0px;" %></td><td style="padding:0px; margin:0px;"><%=   f.time_field :referenced_time, :style =>"padding:0px; margin:0px;" %></td>
           <% if @topic.is_alert then %>
               <td>For (days):</td><td style="padding:0px; margin:0px;"> <%=   f.text_field :duration, :style =>"padding:0px; margin:0px;" %></td>
           <% else %>
             <td colspan=2></td>
           <% end %>
             </tr>

           <tr>
             <td>Hut:</td>
             <td style="padding:0px; margin:0px;">
               <div id="huts"><input id="post_hut" name="post[hut]" style="padding:0px; margin:0px;" type="text" class="typeahead" placeholder="Hut" value='<%=@post.hut%>'></div>
             </td>
             <td>Park:</td>
             <td style="padding:0px; margin:0px;" colspan=2>
               <div id="parks"><input id="post_park" name="post[park]" style="padding:0px; margin:0px;" type="text" class="typeahead" placeholder="Park" value='<%=@post.park%>'></div>
             </td>
           </tr>
           <tr>
             <td>Island:</td>
             <td style="padding:0px; margin:0px;">
               <div id="islands"><input id="post_island" name="post[island]" style="padding:0px; margin:0px;" type="text" class="typeahead" placeholder="Island" value='<%=@post.island%>'></div>
             </td>
             <td>Summit:</td>
             <td style="padding:0px; margin:0px;" colspan=2>
               <div id="summits"><input id="post_summit" name="post[summit]" style="padding:0px; margin:0px;" type="text" class="typeahead" placeholder="Summit" value='<%=@post.summit%>'></div>
             </td>
           </tr>
           <tr>
             <td>Freq(s):</td>
             <td style="padding:0px; margin:0px;" ><%=   f.text_field :freq, :style =>"padding:0px; margin:0px;" %></td>
             <td>Mode(s):</td>
             <td style="padding:0px; margin:0px;" colspan=2><%=   f.text_field :mode, :style =>"padding:0px; margin:0px;" %></td>
           </tr>
         </table>
         <% end %>
         <span>
           <%=f.label :title %>
           <%= f.text_field :title %>
         </span>
   
         <%=f.label :description%>
         <div id="editPanel"></div>
         <span id="descrSpan">
           <%= f.text_area :description %>
         </span>
   <%  if(@submit_button != "Save Changes" and current_user and current_user.is_admin) %>
         <div class="erow">
           <%=f.label "Check to supress emails of this post" %> 
           <%= f.check_box :do_not_publish %>
         </div>
   <% end %>
         <div id="attachments">
           <div class="erow"><div class="sectiontitle">Attachments:</div></div>
           <div class="erow" id="filename_form" style="display:none">
             <div class="sectiontitle25">Filename:</div>
               <%= f.file_field :image %>
             </div>
           </div>
           <div id="link_div">
             <u><i><a href="#" onclick="show_div('filename_form');hide_div('link_div');return(false);">Attach file</a></i></u>
           </div>
           <% if @post.files %>
             <% @post.files.each do |uf| %>
               <div class="erow">
                  <div class="hrline">
                     <hr noshade size="3">
                  </div>
               </div>
               File: <%= uf.image.url.split('/')[4].split('?')[0] %>
             <% end %>
           <% end %>

           <% if @post.images %>
              <% @post.images.each do |image| %>
                 <div class="erow">
                    <div class="hrline">
                      <hr noshade size="3">
                    </div>
                 </div>
              <%= link_to (image_tag image.image.url(:original), style: 'max-height:480px;max-width:480px'), image.image.url(:original), :target=>"_blank"%>
              <% end %>
           <% end %>

    
         </div>
       </div>
  <% end %>
</div>
<script>
var huts = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.whitespace,
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/queries/hut?query=%QUERY',
    wildcard: '%QUERY'
  }
});

  huts.clearPrefetchCache();
  huts.initialize();

  $('#huts .typeahead').typeahead(null, {
    name: 'huts',
    source: huts
  });


var parks = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.whitespace,
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/queries/park?query=%QUERY',
    wildcard: '%QUERY'
  }
});

  parks.clearPrefetchCache();
  parks.initialize();

  $('#parks .typeahead').typeahead(null, {
    name: 'parks',
    source: parks
  });

var islands = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.whitespace,
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/queries/island?query=%QUERY',
    wildcard: '%QUERY'
  }
});

  islands.clearPrefetchCache();
  islands.initialize();

  $('#islands .typeahead').typeahead(null, {
    name: 'islands',
    source: islands
  });

var summits = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.whitespace,
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/queries/summit?query=%QUERY',
    wildcard: '%QUERY'
  }
});

  summits.clearPrefetchCache();
  summits.initialize();

  $('#summits .typeahead').typeahead(null, {
    name: 'summits',
    source: summits
  });

  startEdit();
</script>

